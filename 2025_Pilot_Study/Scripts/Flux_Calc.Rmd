---
title: "Flux_Calc"
author: "Zhang Zhenglin"
output:
  pdf_document:
    toc: yes
editor_options:
  markdown:
    wrap: sentence
---
# Acknowledgement

Heartfelt gratitude to Jack Lamb for providing a functional code architecture that enabled this to be developed.

# Brief overview

In the field, the start time of each chamber enclosure is recorded. Chambers are placed on for 4 minutes. This code removes the first and last minute of chamber enclosures to ensure that the change in concentration is not subject to disturbance. After which, the data points are annotated to the respective plots and individual slopes (ΔC/ΔT) are computed. All linear regressions were inspected to have R2>0.85 for the slope to be accepted. ΔC/ΔT is then computed with chamber parameters including area, volume, and temperature to determine flux for downstream applications and analyses.

# Necessary libraries

```{r message=FALSE,warning=FALSE}
library(knitr)
library(ggplot2)
theme_set(theme_bw())
library(emmeans)
library(multcomp)
library(PLS205)
library(lme4)
library(lmerTest)
library(multcompView)
library(car)
library(Rmisc) 
library(dplyr) #https://r4ds.had.co.nz/ (Chapter 3, Chapter 5, look at filter and select)
# https://bookdown.org/ansellbr/WEHI_tidyR_course_book/
library(stringr) 
library(data.table)
library(GGally)
library(formatR)
library(readxl)
library(FluxCalR)
library(tidyverse)
library(fuzzyjoin)
library(purrr)
library(data.table)
library(broom)
library(lubridate)
library(readxl)
library(openxlsx)
library(ggrepel)
library(gridExtra)

```

# Entering known parameters of the chamber and set up

```{r}
# volume here expressed at cm3, area in cm2 and height in cm
LiCor_internal_vol <- 20
Chamber_lid_height <- 7.62
Chamber_area <- pi*14.75*14.75
```

# Field metadata

```{r}
field <- read_excel("../Field_Data/Field_Data.xlsx", sheet = 1)
str(field)

#chamber volume in cm3 is length multiplied by area. 
#Length is given by (sum of chamber lid)+(headspace)+(extension lenght) 
#Note that headspace can be negative because floodwater may be above the top of the chamber collar
#We also convert volume from cm3 to L in the calculation below 

field$Closure_datetime_start <- as.POSIXct(
  paste(field$Date, format(as.POSIXct(field$Closure_start_time, format = "%Y-%m-%d %H:%M:%S"), "%H:%M:%S")),
  format = "%Y-%m-%d %H:%M:%S"
)

#Create Closure_datetime_end by adding Duration_min (in minutes) to Closure_datetime
#now we have the time that the chamber is enclosured by the Li-Cor Instrument
#Duration_min * 60 converts minutes to seconds (because POSIXct handles times in seconds).
field$Closure_datetime_end <- field$Closure_datetime_start + field$Duration_min * 60

field$mean_headspace <- rowMeans(field[, c("Headspace_1_cm", "Headspace_2_cm", "Headspace_3_cm", "Headspace_4_cm")], na.rm = TRUE)
field$Length_cm <- field$mean_headspace+Chamber_lid_height+(field$Extension_length_ft*30.48)
field$Volume_L <- (field$Length_cm*Chamber_area+LiCor_internal_vol)*0.001

#remove the first and last segments of the chamber enclosure to get stable fluxes. 
field <- field %>%
  mutate(
    trimmed_start = case_when(
      Duration_min > 4 ~ Closure_datetime_start + (Duration_min * 60 - 120) / 2,
      Duration_min == 4 ~ Closure_datetime_start + 60,
      Duration_min < 4 ~ Closure_datetime_start + (Duration_min * 60) / 6
    ),
    trimmed_end = case_when(
      Duration_min > 4 ~ Closure_datetime_end - (Duration_min * 60 - 120) / 2,
      Duration_min == 4 ~ Closure_datetime_end - 60,
      Duration_min < 4 ~ Closure_datetime_end - (Duration_min * 60) / 6
    )
  )

str(field)
```

# Li-Cor Data

## Reading all the relevant Li-Cor files

```{r}
#so far not needed yet so leaving it here
```

## Cleaning the master Li-Cor file

```{r}
raw7810 <- read_tsv("../Raw_Licor_Output_By_Day/TG10-01532-2025-05-31T090000_Until_25Aug2025.data",
                    skip = 5   # skips the first 5 rows      
                    ) %>%
  filter(!row_number() %in% c(1))  #removes the units row of the dataframe

# Combine date and time into a single datetime column, concentration of CH4 is changed from ppm to ppb
needed_data <- data.frame(
  CH4 = as.numeric(raw7810$CH4)*0.001,
  datetime = as.POSIXct(
    paste(raw7810$DATE, raw7810$TIME),  # Combine date and time strings
    format = "%Y-%m-%d %H:%M:%S"        # Adjust format to match data
  ),
  residuals = as.numeric(raw7810$RESIDUAL)
)

needed_data <- needed_data %>%
  filter(residuals < 0.025) %>% #removes datapoints where residuals are low
  mutate(
    date = as.Date(datetime),
    time = format(datetime, "%H:%M:%S")
  ) %>%
  select(CH4, date, time, datetime) 

str(needed_data)
```

## Using field metadata to annotate plots to the Li-Cor data

```{r}
# Convert both dataframes to data.tables
setDT(needed_data)
setDT(field)

# Perform a non-equi join (join where datetime is between trimmed_start and trimmed_end)
licor_annotated <- field[needed_data, 
                         on = .(trimmed_start <= datetime, trimmed_end >= datetime), 
                         .(datetime, CH4,  Plot), 
                         nomatch = 0]

licor_annotated$CH4 <- as.numeric(licor_annotated$CH4)
licor_annotated$Plot <- as.factor(licor_annotated$Plot)

str(licor_annotated)
```

# Flux calculation

## Function that calculates change in CH4 concentration over time (ppm/s)

```{r}
get_CH4_slopes <- function(data) {
  data %>%
    mutate(
      date = as.Date(datetime),
      datetime_num = as.numeric(datetime) - min(as.numeric(datetime), na.rm = TRUE)
    ) %>%
    group_by(Plot, date) %>%
    group_split() %>%
    map_dfr(function(df) {
      if (nrow(df) < 2 || all(is.na(df$CH4))) {
        return(tibble(
          Plot = df$Plot[1],
          date = df$date[1],
          #n = nrow(df),
          #n_ch4 = sum(!is.na(df$CH4)),
          time_span = as.numeric(difftime(max(df$datetime), min(df$datetime), units = "secs")),
          #ch4_var = var(df$CH4, na.rm = TRUE),
          slope = NA_real_,
          r_squared = NA_real_
        ))
      }
      
      model <- tryCatch(lm(CH4 ~ datetime_num, data = df), error = function(e) NULL)
      
      if (is.null(model)) {
        slope <- NA_real_
        r2 <- NA_real_
      } else {
        slope <- coef(model)["datetime_num"]
        r2 <- summary(model)$r.squared
      }
      
      tibble(
        Plot = df$Plot[1],
        date = df$date[1],
        #n = nrow(df),
        #n_ch4 = sum(!is.na(df$CH4)),
        time_span = as.numeric(difftime(max(df$datetime), min(df$datetime), units = "secs")),
        #ch4_var = var(df$CH4, na.rm = TRUE),
        slope = slope,
        r_squared = r2
      )
    })
}

```


## Get CH4 slopes (ppm/s)

```{r}
all_fluxes<- get_CH4_slopes(licor_annotated)

sum(all_fluxes$r_squared < 0.85, na.rm = TRUE)
#all obtained slopes are linear
sum(all_fluxes$time_span < 60, na.rm = TRUE)
#all slopes are obtained from at least 1 minute (>60s) of stable linear concentration increase

all_fluxes %>%
  filter(r_squared < 0.85)
```

# Calculate flux 

## Going from change in concentration to flux

![Equation for calcualting flux](C:/Users/zhang/Documents/GitHub/ERW/Scripts/Flux_Equation.png)

Zhang, Z., Fenster, T. L. D., & Linquist, B. A. (2025). Greenhouse gas emissions altered by the introduction of a year-long fallow to continuous rice systems. Journal of Environmental Quality, 1–15. https://doi.org/10.1002/jeq2.70055

```{r}

#get temperature,volume, and chamber area from field metadata
all_fluxes$Date <- all_fluxes$date

all_fluxes <- all_fluxes %>%
  left_join(field %>% select(Date, Plot, Volume_L, Chamber_Temp_C), 
            by = c("Date", "Plot")) %>%
  mutate(Area=Chamber_area/100000000) #changing from cm2 to ha


# this is to convert change in concentration over time from ppm/s (all_fluxes$slope) to mg L-1 s-1 using ideal gas law
all_fluxes$slope_mg_L_s <- (((all_fluxes$slope)/((((760*22.4)*(273+all_fluxes$Chamber_Temp_C))/(760*273))))*(0.016043))

# get flux with chamber volume and area. Scale from mg/s to mg/d
all_fluxes$CH4_flux_g_ha_day <- ((all_fluxes$slope_mg_L_s)/(all_fluxes$Area))*(all_fluxes$Volume_L)*86400*0.001

all_fluxes$CH4_flux_g_ha_day_all_in_one <- ((((all_fluxes$slope)/((((760*22.4)*(273+all_fluxes$Chamber_Temp_C))/(760*273))))*(0.016043))/(all_fluxes$Area))*(all_fluxes$Volume_L)*86400*0.001
                              
```

# Compiling data and quality check

## Create final dataframe with plot, flux, and date for downstream applications

```{r}
final_flux <- all_fluxes %>% 
  select(Plot, Date, CH4_flux_g_ha_day) %>%
  mutate(
  Treatment = case_when(
Plot %in% c("C1", "C2", "C3") ~ "Control",
Plot %in% c("IP1", "IP2", "IP3") ~ "Photo-inhibited",
TRUE ~ "Other" # This line handles cases where plot is not listed
))
  
str(final_flux)

write.xlsx(all_fluxes, file= "../Computed_Flux/all_fluxes.xlsx", sheetName = "1", rowNames = FALSE)
```

## Flux over time

```{r}
final_flux_graphing <- final_flux %>%
  group_by(Treatment, Date) %>%
  mutate(CH4_flux_g_ha_day_se = sd(CH4_flux_g_ha_day)/sqrt(3)) %>%
  summarise(CH4_flux_g_ha_day = mean(CH4_flux_g_ha_day),
  CH4_flux_g_ha_day_se = mean(CH4_flux_g_ha_day_se))


flux_over_time <- ggplot(final_flux_graphing, aes(x = Date, y = CH4_flux_g_ha_day,  colour =  Treatment))+
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=CH4_flux_g_ha_day-CH4_flux_g_ha_day_se, ymax=CH4_flux_g_ha_day+CH4_flux_g_ha_day_se), size=0.5)+
  
  # First PSII Inhibitor (Propanil) @ 1x rate     
  geom_vline(xintercept = as.POSIXct(c("2025-06-26")), 
             linetype = "dashed", color = "blue") +
  geom_text(aes(x = as.POSIXct("2025-06-26"), 
                y = max(CH4_flux_g_ha_day, na.rm = TRUE) -1000,
                label = "PSII inhibitor 1x rate"),
            angle = 90, vjust = -0.5, hjust = 0, color = "blue", size =4) +
  # Second PSII Inhibitor (Propanil) @ 3x rate     
  geom_vline(xintercept = as.POSIXct(c("2025-07-16")), 
             linetype = "dashed", color = "blue") +
  geom_text(aes(x = as.POSIXct("2025-07-16"), 
                y = max(CH4_flux_g_ha_day, na.rm = TRUE) -1000,
                label = "PSII inhibitor 3x rate"),
            angle = 90, vjust = -0.5, hjust = 0, color = "blue", size =4) +
  # First defoliation     
  geom_vline(xintercept = as.POSIXct(c("2025-08-04")), 
             linetype = "dashed", color = "darkgreen") +
  geom_text(aes(x = as.POSIXct("2025-08-04"), 
                y = max(CH4_flux_g_ha_day, na.rm = TRUE) -1000,
                label = "1st defoliation"),
            angle = 90, vjust = -0.5, hjust = 0, color = "darkgreen", size =4) +
  # Second defoliation     
  geom_vline(xintercept = as.POSIXct(c("2025-08-18")), 
             linetype = "dashed", color = "darkgreen") +
  geom_text(aes(x = as.POSIXct("2025-08-18"), 
                y = max(CH4_flux_g_ha_day, na.rm = TRUE) -1000,
                label = "2nd defoliation"),
            angle = 90, vjust = -0.5, hjust = 0, color = "darkgreen", size =4) 


flux_over_time

ggsave(flux_over_time, filename = "../Figures/flux_over_time.jpg", height = 25, width = 25, units = "cm", dpi=400)
```

## Create PDF with all the plots to visually inspect change in concentration over time is linear
```{r}
# Create a Date column
licor_annotated <- licor_annotated %>%
  mutate(Date = as.Date(datetime))

# Open PDF device
pdf("../Figures/CH4_time_series_by_date.pdf", width = 10, height = 6)

# Loop over every 2 dates (i.e., 2 plots per page)
dates <- unique(licor_annotated$Date)

for (i in seq(1, length(dates), by = 2)) {
  
  # Get current chunk of 1 or 2 dates
  current_dates <- dates[i:min(i+1, length(dates))]
  plot_data <- licor_annotated %>% filter(Date %in% current_dates)

  p <- ggplot(plot_data, aes(x = datetime, y = CH4, color = Plot, group = Plot)) +
    geom_point(size=0.5) +
    facet_wrap(~ Date, ncol = 1, scales = "free_x") +
    #ylim(0, 20) +   
    labs(title = "CH₄ concentration over time",
         x = "Time",
         y = "CH₄ (ppm)") +
    theme_minimal(base_size = 14) +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold"),
      legend.position = "bottom"
    )
  
  print(p)
}

dev.off()
```

## Create graph with unannotated raw data to do side by side comparison

```{r}
# 1. Create buffered_time_range from field
buffered_time_range <- field %>%
  mutate(Date = as.Date(Closure_datetime_start)) %>%
  group_by(Date) %>%
  summarise(
    earliest = min(Closure_datetime_start) - minutes(3),
    latest = max(Closure_datetime_end) + minutes(3),
    .groups = "drop"
  )

# 2. Add Date to needed_data
needed_data <- needed_data %>%
  mutate(Date = as.Date(datetime))

# 3. Join and filter within buffered ranges
filtered_needed_data <- needed_data %>%
  left_join(buffered_time_range, by = "Date") %>%
  filter(datetime >= earliest & datetime <= latest)

# Get list of unique dates
unique_dates <- unique(filtered_needed_data$Date)

# Start PDF device
pdf("../Figures/unannotated_CH4_by_date_filtered.pdf", width = 11, height = 8.5)  # 2 plots per page

# Loop through dates in pairs
for (i in seq(1, length(unique_dates), by = 2)) {
  date1 <- unique_dates[i]
  date2 <- if (i + 1 <= length(unique_dates)) unique_dates[i + 1] else NA
  
  # Plot for date1
  plot1 <- ggplot(filter(filtered_needed_data, Date == date1), aes(x = datetime, y = CH4)) +
    geom_line() +
    labs(title = paste("CH₄ Over Time -", date1), x = "Time", y = "CH₄ (ppm)") +
    theme_minimal()
  
  # Plot for date2 if available
  if (!is.na(date2)) {
    plot2 <- ggplot(filter(filtered_needed_data, Date == date2), aes(x = datetime, y = CH4)) +
      geom_line() +
      labs(title = paste("CH₄ Over Time -", date2), x = "Time", y = "CH₄ (ppm)") +
      theme_minimal() 
    
    grid.arrange(plot1, plot2, ncol = 1)
  } else {
    grid.arrange(plot1, ncol = 1)
  }
}

# Close PDF
dev.off()
```

# Additonal graph where annotated and non-annotated data are both present

```{r}
# Create Date column in both datasets
licor_annotated <- licor_annotated %>%
  mutate(Date = as.Date(datetime))

filtered_needed_data <- filtered_needed_data %>%
  mutate(Date = as.Date(datetime))

# Get shared list of dates
dates <- sort(unique(licor_annotated$Date))

# Open PDF device (side-by-side comparison, 2 per page)
pdf("../Figures/CH4_annotated_vs_unannotated.pdf", width = 11, height = 8.5)

for (i in seq(1, length(dates), by = 2)) {
  
  current_dates <- dates[i:min(i+1, length(dates))]
  
  # Subset annotated & unannotated
  annotated_sub <- licor_annotated %>% filter(Date %in% current_dates)
  unannotated_sub <- filtered_needed_data %>% filter(Date %in% current_dates)
  
  # Build plot
  p <- ggplot() +
    # Unannotated first (background, grey lines)
    geom_line(data = unannotated_sub, aes(x = datetime, y = CH4), color = "grey60", alpha = 0.6) +
    # Annotated overlay (colored by Plot)
    geom_point(data = annotated_sub, aes(x = datetime, y = CH4, color = Plot), size = 0.6) +
    geom_line(data = annotated_sub, aes(x = datetime, y = CH4, color = Plot), size = 0.4) +
    facet_wrap(~ Date, ncol = 1, scales = "free_x") +
    labs(title = "CH₄ concentration over time (Annotated vs. Raw)",
         x = "Time",
         y = "CH₄ (ppm)") +
    theme_minimal(base_size = 14) +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold"),
      legend.position = "bottom"
    )
  
  print(p)
}

dev.off()

```


